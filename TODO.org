* DONE Refactor first Itinerary MAP - Cuba1 :
 ... without Maria La Gorda itinerary

* PROCESS Create second Itinerary MAP - Cuba2
See itinerary details: [[file:README.org::*CUBA2]]

** DONE [0] Keep existing western route, remove Trinidad → Habana loop
Marcel's requirement: Keep Viñales, Soroa, Playa Larga, Trinidad route intact,
but remove the S-curve closing loop from Trinidad back to Habana.

Action plan:
- [X] Locate drawSCurveRoute() call for Trinidad → Habana in map.js (map.js:348-352)
- [X] Comment out or remove the Trinidad → Habana S-curve route
- [X] Verify María la Gorda ↔ Viñales bidirectional route remains
- [X] Test that western route stops at Trinidad (Habana → Viñales → Soroa → Playa Larga → Cienfuegos → Trinidad)
- [X] Ensure all existing city markers remain visible

Status: Completed. Trinidad → Habana loop removed. Route now ends at Trinidad.

** DONE Add 5 new cities to cuba-locations-geojson.json
- [X] Camagüey (21.38°N, -77.92°W)
- [X] Santiago de Cuba (20.0247°N, -75.8219°W)
- [X] Baracoa (20.3475°N, -74.5024°W)
- [X] Faro de Maisi (20.2089°N, -74.1336°W - extreme east point)
- [X] Yumurí / Boca de Yumurí (20.3009°N, -74.2976°W)

** DONE Add eastern extension routes
- [X] Trinidad → Camagüey (map.js:384-386)
- [X] Camagüey → Santiago de Cuba (map.js:388-390)
- [X] Santiago de Cuba → Baracoa (map.js:392-394)
- [X] Baracoa ↔ Santiago de Cuba (bidirectional with double arrows) (map.js:396-399)
- [X] Santiago de Cuba → Habana (straight nightbus line) (map.js:401-404)
- [X] Add Camagüey and Santiago de Cuba to CUBA2 cities list (map.js:432)
- [X] Add label positioning for new cities (map.js:491-496)

** DONE Optional: Add eastern circular loop (anti-clockwise)
- [X] Baracoa → Faro de Maisi (south)
- [X] Faro de Maisi → Yumurí
- [X] Yumurí → Baracoa (completing the loop)

** DONE Add toggle functionality to switch between itineraries
- [X] Add CUBA1 and CUBA2 toggle buttons to index.html
- [X] Implement clearMap() function to remove routes/markers
- [X] Modify initializeMap() to accept itinerary parameter
- [X] Set cities to show based on itinerary (CUBA1 vs CUBA2)
- [X] Conditionally draw eastern loop only for CUBA2
- [X] Wire up toggle button click handlers
- [X] Update export filename to include itinerary name

** DONE Create separate files for CUBA2 (clean start from scratch)
- [X] Create index2.html for CUBA2
- [X] Create map2.js for CUBA2
- [X] Add all 11 CUBA2 city markers (no routes yet)
- [X] Reuse cuba.svg base map
- [X] Export button wired to save as cuba-map2-west-to-east.svg

** DONE Clarify CUBA2 itinerary with Marcel
Questions to ask:
- Does CUBA2 start from Habana or directly from Viñales? : START AT HABANA, THEN VINALES ETC
- Should Cienfuegos be included (between Playa Larga and Trinidad)?: YES
- Is María la Gorda bidirectional route in CUBA2 or only CUBA1? DO NOT include MARIA LA GORDA in any of the itineraries

** DONE CRITICAL: Fix coordinate/map projection mismatch
*** Problem
City markers are incorrectly positioned on the map. Many cities appear in the water instead of on land.

Evidence: See Screenshots/CubaMap2.3.png
- Santiago de Cuba appears in the sea (south coast)
- Should be inland on the southeast coast

*** Root Cause
Mismatch between:
1. GeoJSON coordinates (real lat/lng): Santiago = 20.0247°N, -75.8219°W
2. SVG base map projection/coordinate system
3. latLngToSVG() conversion function using incorrect bounds or formula

*** Investigation completed
- [X] Verify cuba.svg projection type (Mercator? Equirectangular? Custom?)
  - SVG uses viewBox="0 0 1795.312 760.622" with linear coordinates
- [X] Check actual SVG path data to find real Santiago position in cuba.svg
  - Eastern Cuba paths start around x=1581, confirming coordinate system
- [X] Calibrate CUBA_BOUNDS constants to match SVG projection
  - Created projection-config.js with centralized CUBA_BOUNDS
- [X] Test conversion with known accurate cities (Habana should be on north coast)
  - Created calibrate-projection.html tool for interactive testing
- [X] Adjust OFFSET values if needed
  - Using OFFSET = { x: 0, y: 40 } as baseline

*** Current conversion (map2.js:46-66)
#+begin_src javascript
const CUBA_BOUNDS = {
  north: 23.4,
  south: 19.6,
  west: -85.2,
  east: -73.9
};
const OFFSET = { x: 0, y: 40 };
#+end_src

May need different bounds or transformation formula.

*** DONE CUBA2 map with markers only (no itineraries)

**** Solution Implemented
Created three new files to solve the projection mismatch problem:

1. **projection-config.js** - Centralized projection module
   - Exports SVG_SIZE, CUBA_BOUNDS, OFFSET constants
   - latLngToSVG() function for coordinate conversion
   - getCityYAdjustment() for city-specific positioning
   - getCityLabelPosition() for label placement configuration

2. **map2-markers-only.js** - Refactored CUBA2 map (markers only)
   - Imports shared projection-config.js
   - Shows only CUBA2 cities (11 cities, no María la Gorda)
   - No routes drawn (for testing marker positioning)
   - Exports as 'cuba-map2-cities-only.svg'

3. **index2-markers-only.html** - Test page for markers-only version
   - Clean interface to verify marker positions
   - Links to map2-markers-only.js module

4. **calibrate-projection.html** - Interactive calibration tool
   - Adjust CUBA_BOUNDS and OFFSET in real-time
   - Test with 6 reference cities
   - Displays calculated SVG coordinates
   - Helps fine-tune projection parameters

**** DONE Manual Calibration Completed (2025-11-25)

**Per-City Calibration System Implemented:**

5. **calibrate-per-city.html** - Advanced per-city calibration tool
   - City-by-city navigation (11 cities)
   - Real-time sliders + keyboard controls (arrow keys, Enter, R)
   - Visual feedback: gray baseline + red adjusted markers
   - Save/Load progress to localStorage
   - Export CITY_OFFSETS configuration code

**Calibration Results (v1):**

Manually calibrated all 11 cities using calibrate-per-city.html tool.
Applied offsets to projection-config.js:

- Western cities (Habana, Viñales, Soroa): deltaY ≈ 0 to +6
- Central cities: deltaY ≈ 0 to -28, some deltaX adjustments
  - Playa Larga: deltaX=+9, deltaY=0
  - Cienfuegos: deltaX=+4, deltaY=0
  - Trinidad: deltaY=-28
  - Camagüey: deltaY=-17
- Eastern cities: deltaY ≈ -84 to -93 (major correction!)
  - Santiago de Cuba: deltaY=-91 ⭐
  - Baracoa: deltaY=-84
  - Faro de Maisi: deltaY=-93
  - Yumurí: deltaY=-85

**Key Findings:**
- SVG projection is MORE non-linear than initially estimated
- Eastern Cuba requires ~90px correction (not +80 as predicted)
- Negative deltaY = move markers UP (north)
- Baseline calculated positions too far south for eastern Cuba

**Files:**
- projection-config.js: Updated with calibrated CITY_OFFSETS
- calibrate-per-city-v1.js: Exported calibration results (backup)

**Status:** ✅ All cities now positioned correctly on land
**Verified:** index2-markers-only.html shows correct positioning

**** Next Steps
1. ✅ DONE: Per-city calibration tool created
2. ✅ DONE: All 11 cities manually calibrated
3. ✅ DONE: CITY_OFFSETS applied to projection-config.js
4. ✅ DONE: Test with index2-markers-only.html - ALL CITIES ON LAND
5. TODO: Add routes back to map2.js (with calibrated positions)

*** PROCESS CUBA2 map with markers only (no itineraries) - ORIGINAL NOTES

#+name: next milestone - 1st priority
#+begin_src markdown
### Update: CUBA2 map with markers only (no itineraries)

For now I only need a **CUBA2 map with well‑positioned locations and their markers**, without any itineraries/routes drawn.

#### 1. Shared projection config

Introduce a shared projection / conversion helper:

```javascript
// projection-config.js
// Centralized projection / bounds for Cuba SVG

// SVG size from cuba.svg (viewBox / width / height)
export const SVG_SIZE = {
  width: 1795.312,
  height: 760.622,
};

// Initial bounds (rough; can be fine‑tuned by calibration)
export const CUBA_BOUNDS = {
  north: 23.4,
  south: 19.6,
  west: -85.2,
  east: -73.8,
};

// Global offset if needed to nudge markers
export const OFFSET = {
  x: 0,
  y: 40,
};

/**
 * Convert latitude/longitude to SVG x,y using a simple linear mapping.
 * This should be calibrated against a few reference cities in cuba.svg.
 */
export function latLngToSVG(lat, lng) {
  const { width, height } = SVG_SIZE;

  const x =
    ((lng - CUBA_BOUNDS.west) /
      (CUBA_BOUNDS.east - CUBA_BOUNDS.west)) *
      width +
    OFFSET.x;

  const y =
    ((CUBA_BOUNDS.north - lat) /
      (CUBA_BOUNDS.north - CUBA_BOUNDS.south)) *
      height +
    OFFSET.y;

  return { x, y };
}

Once this is in place, `CUBA_BOUNDS` and `OFFSET` can be calibrated here only, and any map (CUBA1/CUBA2) using this helper stays in sync.

#### 2\. Refactor `map2.js` to show **only CUBA2 markers and labels**

Then simplify `map2.js` so it imports the shared projection and _only_ renders markers and labels for the CUBA2 cities (no routes):
```js
// map2.js
import { SVG_SIZE, latLngToSVG } from './projection-config.js';

window.addEventListener('DOMContentLoaded', () => {
  console.log('map2.js (CUBA2 markers only) loaded');

  setTimeout(() => {
    const mapObject = document.getElementById('cuba-map');
    if (!mapObject) {
      console.error('Could not find #cuba-map object element');
      return;
    }

    // Export function: download complete SVG with markers
    const exportSVG = (svgDoc) => {
      const svgElement = svgDoc.querySelector('svg');
      if (!svgElement) {
        console.error('No <svg> element found for export');
        return;
      }

      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svgElement);

      const blob = new Blob([svgString], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = 'cuba-map2-cities.svg';
      link.click();

      URL.revokeObjectURL(url);
    };

    const initializeMap = () => {
      console.log('initializeMap called (CUBA2 markers only)');
      const svgDoc = mapObject.contentDocument;
      if (!svgDoc) {
        console.error('SVG document not loaded');
        return;
      }

      const svgElement = svgDoc.querySelector('svg');
      if (!svgElement) {
        console.error('SVG element not found inside object');
        return;
      }

      const { width: svgWidth, height: svgHeight } = SVG_SIZE;
      console.log('Using SVG_SIZE:', SVG_SIZE);

      // Load GeoJSON data and add ONLY markers/labels (no routes)
      fetch('cuba-locations-geojson.json')
        .then((response) => response.json())
        .then((data) => {
          console.log('GeoJSON data loaded:', data);

          // CUBA2 city list (no María la Gorda)
          const citiesToShow = [
            'Habana',
            'Viñales',
            'Soroa',
            'Playa Larga',
            'Cienfuegos',
            'Trinidad',
            'Camagüey',
            'Santiago de Cuba',
            'Baracoa',
            'Faro de Maisi',
            'Yumurí',
          ];

          data.features
            .filter((feature) => citiesToShow.includes(feature.properties.name))
            .forEach((feature) => {
              const [lng, lat] = feature.geometry.coordinates;
              const { x, y } = latLngToSVG(lat, lng);

              // Marker circle
              const marker = svgDoc.createElementNS(
                'http://www.w3.org/2000/svg',
                'circle',
              );

              // Keep small manual tweaks where useful
              let adjustedY = y;
              if (feature.properties.name === 'Habana') {
                adjustedY = y + 5; // small tweak
              } else if (feature.properties.name === 'Trinidad') {
                adjustedY = y - 25; // small tweak
              }

              marker.setAttribute('cx', x);
              marker.setAttribute('cy', adjustedY);
              marker.setAttribute('r', '4');
              marker.setAttribute('fill', '#ff4444');
              marker.setAttribute('stroke', '#ffffff');
              marker.setAttribute('stroke-width', '1');
              marker.setAttribute('cursor', 'pointer');

              // Label group (background rect + text)
              const labelGroup = svgDoc.createElementNS(
                'http://www.w3.org/2000/svg',
                'g',
              );

              let labelX = x;
              let labelY = adjustedY - 8;

              // Reuse existing manual label positioning
              if (feature.properties.name === 'Viñales') {
                labelX = x - 30;
                labelY = adjustedY - 5;
              } else if (feature.properties.name === 'Habana') {
                labelX = x + 25;
                labelY = adjustedY - 5;
              } else if (feature.properties.name === 'Soroa') {
                labelX = x;
                labelY = adjustedY - 13;
              } else if (feature.properties.name === 'Playa Larga') {
                labelX = x + 30;
                labelY = adjustedY + 10;
              } else if (feature.properties.name === 'Cienfuegos') {
                labelX = x - 20;
                labelY = adjustedY + 18;
              } else if (feature.properties.name === 'Trinidad') {
                labelX = x;
                labelY = adjustedY + 22;
              } else if (feature.properties.name === 'Camagüey') {
                labelX = x;
                labelY = adjustedY - 12;
              } else if (feature.properties.name === 'Santiago de Cuba') {
                labelX = x + 20;
                labelY = adjustedY + 15;
              } else if (feature.properties.name === 'Baracoa') {
                labelX = x;
                labelY = adjustedY - 10;
              } else if (feature.properties.name === 'Faro de Maisi') {
                labelX = x + 15;
                labelY = adjustedY + 15;
              } else if (feature.properties.name === 'Yumurí') {
                labelX = x - 15;
                labelY = adjustedY - 10;
              }

              const textBg = svgDoc.createElementNS(
                'http://www.w3.org/2000/svg',
                'rect',
              );
              const textWidth = feature.properties.name.length * 7;
              textBg.setAttribute('x', labelX - textWidth / 2 - 2);
              textBg.setAttribute('y', labelY - 12);
              textBg.setAttribute('width', textWidth + 4);
              textBg.setAttribute('height', 16);
              textBg.setAttribute('fill', '#ffffff');
              textBg.setAttribute('fill-opacity', '0.8');
              textBg.setAttribute('stroke', '#333333');
              textBg.setAttribute('stroke-width', '0.5');
              textBg.setAttribute('rx', '3');

              const label = svgDoc.createElementNS(
                'http://www.w3.org/2000/svg',
                'text',
              );
              label.setAttribute('x', labelX);
              label.setAttribute('y', labelY);
              label.setAttribute('text-anchor', 'middle');
              label.setAttribute('font-family', 'Arial, sans-serif');
              label.setAttribute('font-size', '12');
              label.setAttribute('font-weight', 'bold');
              label.setAttribute('fill', '#333333');
              label.textContent = feature.properties.name;

              labelGroup.appendChild(textBg);
              labelGroup.appendChild(label);

              marker.addEventListener('click', () => {
                const props = feature.properties;
                alert(
                  `${props.name}\nType: ${props.type}\nProvince: ${
                    props.province || 'N/A'
                  }\nNotable: ${props.notable || 'N/A'}`,
                );
              });

              svgElement.appendChild(marker);
              svgElement.appendChild(labelGroup);
            });

          console.log('CUBA2 markers added (no routes)');

          const exportBtn = document.getElementById('export-btn');
          if (exportBtn) {
            exportBtn.addEventListener('click', () => exportSVG(svgDoc));
          }
        })
        .catch((error) => console.error('Error loading GeoJSON:', error));
    };

    if (mapObject.contentDocument) {
      initializeMap();
    } else {
      mapObject.addEventListener('load', initializeMap);
    }
  }, 100);
});
```

With this change, `CUBA2` becomes a clean **city-marker-only** map. Once the projection / bounds are calibrated and all markers sit properly on land (especially Santiago and the eastern cities), itineraries can be added back later on top of this corrected base.
--

#+end_src

** WAIT Add routes to CUBA2 once itinerary confirmed
Based on Marcel's confirmed requirements:
- [X] Habana → Viñales → Soroa → Playa Larga → Cienfuegos → Trinidad (map2.js:247-269)
- [X] Trinidad → Camagüey → Santiago de Cuba → Baracoa (map2.js:273-285)
- [X] Baracoa ↔ Santiago de Cuba (bidirectional) (map2.js:288-290)
- [X] Santiago de Cuba → Habana (straight nightbus, curvature=0) (map2.js:293-295)
- [X] Optional: Baracoa → Faro de Maisi → Yumurí → Baracoa (circular loop) (map2.js:298-311)

** TODO Test all routes stay 100% inland
Especially check the long Santiago de Cuba → Habana nightbus route

** TODO Refactor CUBA2 to reuse western routes from CUBA1
*** Problem
CUBA2 is redrawing routes for Habana → Viñales → Soroa → Playa Larga → Cienfuegos → Trinidad even though these EXACT same routes already exist in CUBA1 (map.js).

This violates DRY principle (Don't Repeat Yourself).

*** Current situation
- map.js (CUBA1): Has working routes with tested curvature values
- map2.js (CUBA2): Duplicates the same route code with same curvature values

*** Action items
- [ ] Extract western route definitions into shared module or function
- [ ] Import/reuse western routes in both map.js and map2.js
- [ ] Keep only CUBA2-specific eastern routes in map2.js:
  - Trinidad → Camagüey → Santiago de Cuba → Baracoa
  - Baracoa ↔ Santiago de Cuba (bidirectional)
  - Santiago de Cuba → Habana (nightbus)
  - Optional eastern loop
- [ ] Consider creating routes-config.js with route definitions

*** Benefits
- Single source of truth for western routes
- Easier maintenance (change once, apply everywhere)
- Reduced code duplication
- Smaller bundle size

* WAIT Update export functionality (2nd priority )
Ensure SVG export works correctly with all new routes and cities 
